<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OSD Driver Sign-Off</title>
<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#4f46e5}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink);margin:0}
  .container{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
  h1{font-size:28px;margin:8px 0 16px}
  label{display:block;font-size:13px;color:#475569;margin:8px 0 6px}
  input,textarea,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none}
  input:focus,textarea:focus,select:focus{border-color:var(--brand)}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2ff;color:#111827}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:12px}
  .sig{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sigbar{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px 10px}
  canvas{display:block;width:100%;height:180px}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .thumbs img{width:100%;height:100px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
  .success{background:#ecfdf5;border:1px solid #10b98133;color:#065f46;padding:10px 12px;border-radius:12px}
  .error{background:#fef2f2;border:1px solid #ef444433;color:#7f1d1d;padding:10px 12px;border-radius:12px}
</style>
</head>
<body>
<div class="container">
  <h1>OSD – Driver Sign-Off</h1>

  <div id="alert"></div>

  <form id="osdForm" class="card">
    <div class="grid grid-2">
      <div>
        <label>Date/Time</label>
        <input type="datetime-local" name="date" id="date"/>
      </div>
      <div>
        <label>Location *</label>
        <select name="location" id="location" required>
          <option value="">Select Dock</option>
          <option value="Dock 17 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 17 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
          <option value="Dock 18 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 18 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
          <option value="Dock 19 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 19 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
        </select>
      </div>
      <div>
        <label>Load ID / BOL #</label>
        <input name="bol" id="bol"/>
      </div>
      <div>
        <label>PO Number</label>
        <input name="po" id="po"/>
      </div>
      <div>
        <label>Trailer #</label>
        <input name="trailer" id="trailer"/>
      </div>
      <div>
        <label>Stop #</label>
        <input name="stop" id="stop"/>
      </div>
      <div>
        <label>Carrier</label>
        <input name="carrier" id="carrier"/>
      </div>
      <div>
        <label>Vendor ID</label>
        <input name="vendorId" id="vendorId"/>
      </div>
      <div>
        <label>Vendor Name</label>
        <input name="vendorName" id="vendorName"/>
      </div>
    </div>

    <label>Notes / Exceptions</label>
    <textarea name="notes" id="notes" rows="5" placeholder="Possible damages, shortages, and overages..."></textarea>

    <div class="row">
  <div style="flex:1">
    <label>Driver Name *</label>
    <input name="driverName" id="driverName" required/>
  </div>
  <div style="flex:1">
    <label>PRO #</label>
    <input name="proNumber" id="proNumber"/>
  </div>
</div>

    <div class="sig" style="margin-top:12px">
      <div class="sigbar">
        <span class="muted">Driver signature (draw in the box)</span>
        <button type="button" class="btn btn-ghost" id="clearSig">Clear</button>
      </div>
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="margin-top:12px">
      <label>Photos (optional)</label>
      <input type="file" id="photos" multiple accept="image/*"/>
      <div class="thumbs" id="thumbs"></div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="submitBtn">Submit (Generate & Email PDF)</button>
    </div>
  </form>

  <p class="muted">Set your backend URL inside the script to enable PDF emailing.</p>
</div>

<script>
  // ======== CONFIG ========
  const BACKEND_URL = 'https://YOUR-RENDER-URL.onrender.com'; // <-- change after backend deploy
  // ========================

  // Prefill local datetime
  (function(){
    const d = new Date();
    const p = n => String(n).padStart(2,'0');
    const val = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    document.getElementById('date').value = val;
  })();

  // Signature pad
  const canvas = document.getElementById('sigCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false, last=[0,0], signatureDataUrl = '';
  function resize(){
    const ratio = window.devicePixelRatio || 1;
    const w = canvas.clientWidth || canvas.parentElement.clientWidth; const h = 180;
    canvas.width = Math.floor(w * ratio); canvas.height = Math.floor(h * ratio);
    canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    ctx.lineWidth = 2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111827';
  }
  new ResizeObserver(resize).observe(canvas); resize();
  const pos = e => { const r=canvas.getBoundingClientRect(); const t=e.touches?.[0]; const x=(t?t.clientX:e.clientX)-r.left; const y=(t?t.clientY:e.clientY)-r.top; return [x,y]; };
  const down = e => { e.preventDefault(); drawing=true; last=pos(e)};
  const move = e => { if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(...last); ctx.lineTo(...p); ctx.stroke(); last=p };
  const up = () => { drawing=false; signatureDataUrl = canvas.toDataURL('image/png'); };
  canvas.addEventListener('mousedown',down); canvas.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
  canvas.addEventListener('touchstart',down,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',up);
  document.getElementById('clearSig').onclick = () => { ctx.clearRect(0,0,canvas.width,canvas.height); signatureDataUrl = '' };

  // Photo previews + compression
  const photosInput = document.getElementById('photos');
  const thumbs = document.getElementById('thumbs');
  photosInput.addEventListener('change', () => {
    thumbs.innerHTML='';
    [...photosInput.files].forEach(file => {
      const url = URL.createObjectURL(file);
      const img = document.createElement('img'); img.src = url; img.onload = () => URL.revokeObjectURL(url);
      thumbs.appendChild(img);
    });
  });

  function readImageAsDataURL(file, maxW=1600, maxH=1600, quality=0.85){
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const ratio = Math.min(1, maxW/img.width, maxH/img.height);
          const c = document.createElement('canvas');
          c.width = Math.round(img.width*ratio);
          c.height = Math.round(img.height*ratio);
          const cx = c.getContext('2d');
          cx.drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg', quality));
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });
  }

  // Submit handler -> POST JSON to backend
  document.getElementById('osdForm').addEventListener('submit', async (e) => {
    e.preventDefault();
  <script>
  // ✅ Backend endpoint
  const BACKEND_URL = "https://osd-webform.onrender.com/api/signoff";

  const alertBox = document.getElementById('alert');
  const form = document.getElementById('osdForm');
  const submitBtn = document.getElementById('submitBtn');

  // helper: file -> dataURL
  function readImageAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertBox.innerHTML = '';

    const location = document.getElementById('location').value.trim();
    const driverName = document.getElementById('driverName').value.trim();
    if (!location || !driverName) {
      alertBox.innerHTML = `<div class="error">Location and Driver Name are required.</div>`;
      return;
    }

    // collect optional photos
    const photosInput = document.getElementById('photos'); // ensure your input has id="photos"
    const files = photosInput ? [...photosInput.files] : [];
    const photos = [];
    for (const f of files) {
      photos.push({ name: f.name, dataUrl: await readImageAsDataURL(f) });
    }

    // signature canvas support (assumes you’ve set signatureDataUrl elsewhere)
    const signature = window.signatureDataUrl || '';

    // build payload (mapped to backend keys; extra fields are fine)
    const payload = {
      timestamp: document.getElementById('date')?.value || new Date().toISOString(),
      location,
      loadId: document.getElementById('bol')?.value || '',
      poNumber: document.getElementById('po')?.value || '',
      trailerNumber: document.getElementById('trailer')?.value || '',
      stopNumber: document.getElementById('stop')?.value || '',
      carrier: document.getElementById('carrier')?.value || '',
      vendorId: document.getElementById('vendorId')?.value || '',
      vendorName: document.getElementById('vendorName')?.value || '',
      notes: document.getElementById('notes')?.value || '',
      driverName,
      driverId: document.getElementById('driverId')?.value || '',
      driverInitials: document.getElementById('driverInitials')?.value || '',
      signatureDataUrl: signature,
      photos,                                // optional; backend can ignore if not used
      device: navigator.userAgent,
      submittedAt: new Date().toISOString(),
      toEmail: document.getElementById('toEmail')?.value || '' // optional override
    };

    submitBtn.disabled = true;

    try {
      const resp = await fetch(BACKEND_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const out = await resp.json().catch(() => ({}));
      if (!resp.ok || out.ok === false) throw new Error(out.error || 'Submit failed');

      alertBox.innerHTML = `<div class="success">✅ Submitted! PDF emailed${out.id ? ' · Ref: ' + out.id : ''}.</div>`;
      form.reset();
      // clear signature + thumbnails if present
      if (window.ctx && window.canvas) { window.ctx.clearRect(0,0,canvas.width,canvas.height); }
      window.signatureDataUrl = '';
      const thumbs = document.getElementById('thumbs');
      if (thumbs) thumbs.innerHTML = '';
    } catch (err) {
      console.error(err);
      alertBox.innerHTML = `<div class="error">❌ ${err.message}</div>`;
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
