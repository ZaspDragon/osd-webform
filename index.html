<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OSD – Driver Sign-Off</title>

<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#4f46e5}
  *{box-sizing:border-box}
  body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink);margin:0}
  .container{max-width:960px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
  h1{font-size:28px;margin:8px 0 16px}
  label{display:block;font-size:13px;color:#475569;margin:8px 0 6px}
  input,textarea,select{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff}
  input:focus,textarea:focus,select:focus{border-color:var(--brand)}
  .grid{display:grid;gap:12px}
  @media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-ghost{background:#eef2ff;color:#111827;border:none;border-radius:10px;padding:8px 12px}
  .muted{color:var(--muted);font-size:12px}
  .alert{padding:10px 14px;border-radius:12px;margin:10px 0;font-weight:600}
  .alert.success{background:#e8f7ee;border:1px solid #31a24c;color:#166534}
  .alert.error{background:#fdeaea;border:1px solid #dc2626;color:#7f1d1d}
  .sig{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .sigbar{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px 10px}
  #sigCanvas{display:block;width:100%;height:180px;background:#f9fafb;touch-action:none}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:100px;object-fit:cover;border:1px solid var(--line);border-radius:8px}
</style>
</head>
<body>
<div class="container">
  <h1>OSD – Driver Sign-Off</h1>

  <div id="alert"></div>

  <form id="osdForm" class="card" novalidate>
    <div class="grid grid-2">
      <div>
        <label>Date/Time</label>
        <input type="datetime-local" id="date"/>
      </div>
      <div>
        <label>Location *</label>
        <select id="location" required>
          <option value="">Select Dock</option>
          <option value="Dock 17 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 17 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
          <option value="Dock 18 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 18 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
          <option value="Dock 19 – 6121 Bixby Rd, Canal Winchester OH 43110">Dock 19 – 6121 Bixby Rd, Canal Winchester OH 43110</option>
        </select>
      </div>
      <div><label>Load ID / BOL #</label><input id="bol"/></div>
      <div><label>PO Number</label><input id="po"/></div>
      <div><label>Trailer #</label><input id="trailer"/></div>
      <div><label>Stop #</label><input id="stop"/></div>
      <div><label>Carrier</label><input id="carrier"/></div>
      <div><label>Vendor ID</label><input id="vendorId"/></div>
      <div><label>Vendor Name</label><input id="vendorName"/></div>
    </div>

    <label>Notes / Exceptions</label>
    <textarea id="notes" rows="5" placeholder="Possible damages, shortages, and overages..."></textarea>

    <div class="row">
      <div style="flex:1">
        <label>Driver Name *</label>
        <input id="driverName" required/>
      </div>
      <div style="flex:1">
        <label>PRO #</label>
        <input id="proNumber"/>
      </div>
    </div>

    <div class="sig" style="margin-top:12px">
      <div class="sigbar">
        <span class="muted">Driver signature (draw in the box)</span>
        <button type="button" class="btn-ghost" id="clearSig">Clear</button>
      </div>
      <canvas id="sigCanvas"></canvas>
    </div>

    <div style="margin-top:12px">
      <label>Photos (optional)</label>
      <input type="file" id="photos" multiple accept="image/*"/>
      <div class="thumbs" id="thumbs"></div>
    </div>

    <!-- Email controls -->
    <div class="grid grid-2 card" style="margin-top:12px">
      <div>
        <label>Email To (comma-separated)</label>
        <input id="toEmail" placeholder="ops@company.com, manager@company.com"/>
      </div>
      <div>
        <label>CC (optional)</label>
        <input id="ccEmail" placeholder="qc@company.com"/>
      </div>
      <div>
        <label>BCC (optional)</label>
        <input id="bccEmail" placeholder="audit@company.com"/>
      </div>
      <div>
        <label>Subject (optional)</label>
        <input id="emailSubject" placeholder="OSD Sign-Off"/>
      </div>
    </div>

    <div class="card">
      <label>Email Message (optional)</label>
      <textarea id="emailMessage" rows="4" placeholder="Any extra context to include in the email body..."></textarea>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="submitBtn">Submit (Generate & Email PDF)</button>
    </div>
  </form>
</div>

<script>
  // ---- Config ----
  const BACKEND_URL = "https://osd-webform.onrender.com/api/signoff";

  // Prefill local datetime
  (function prefillDate(){
    const d = new Date(), p = n => String(n).padStart(2,'0');
    const val = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    document.getElementById('date').value = val;
  })();

  const alertBox  = document.getElementById('alert');
  const form      = document.getElementById('osdForm');
  const submitBtn = document.getElementById('submitBtn');

  // ---- Signature pad (pointer events) ----
  const canvas = document.getElementById('sigCanvas');
  const ctx    = canvas.getContext('2d');
  let drawing=false, lastX=0, lastY=0;
  window.signatureDataUrl = "";

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width  = Math.floor(rect.width * ratio);
    canvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth=2.5; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111827';
  }
  resizeCanvas(); new ResizeObserver(resizeCanvas).observe(canvas);

  function pt(e){ const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top}; }
  canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); drawing=true; const p=pt(e); lastX=p.x; lastY=p.y; });
  canvas.addEventListener('pointermove', e=>{ if(!drawing) return; const p=pt(e); ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(p.x,p.y); ctx.stroke(); lastX=p.x; lastY=p.y; });
  function endStroke(){ if(!drawing) return; drawing=false; window.signatureDataUrl = canvas.toDataURL('image/png'); }
  canvas.addEventListener('pointerup', endStroke);
  canvas.addEventListener('pointerleave', endStroke);
  canvas.addEventListener('pointercancel', endStroke);
  document.getElementById('clearSig').addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); window.signatureDataUrl=""; });

  // ---- Photo previews + light compression ----
  const photosInput = document.getElementById('photos');
  const thumbs      = document.getElementById('thumbs');
  photosInput.addEventListener('change', ()=>{
    thumbs.innerHTML=''; [...photosInput.files].forEach(file=>{
      const url = URL.createObjectURL(file); const img = document.createElement('img');
      img.src = url; img.onload=()=>URL.revokeObjectURL(url); thumbs.appendChild(img);
    });
  });

  function fileToDataURL(file, maxW=1600, maxH=1600, quality=0.85){
    return new Promise(resolve=>{
      const fr=new FileReader();
      fr.onload=()=>{ const img=new Image(); img.onload=()=>{
        const s=Math.min(1,maxW/img.width,maxH/img.height);
        const c=document.createElement('canvas'); c.width=Math.round(img.width*s); c.height=Math.round(img.height*s);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        resolve(c.toDataURL('image/jpeg', quality));
      }; img.src=fr.result; }; fr.readAsDataURL(file);
    });
  }

  // ---- Submit ----
  form.addEventListener('submit', async (e)=>{
    e.preventDefault(); alertBox.innerHTML='';

    const location   = document.getElementById('location').value.trim();
    const driverName = document.getElementById('driverName').value.trim();
    if(!location || !driverName){ alertBox.innerHTML = `<div class="alert error">Location and Driver Name are required.</div>`; return; }

    const files  = photosInput ? [...photosInput.files] : [];
    const photos = [];
    for(const f of files){ photos.push({ name:f.name, dataUrl: await fileToDataURL(f) }); }

    const payload = {
      timestamp: document.getElementById('date').value || new Date().toISOString(),
      location,
      loadId: document.getElementById('bol').value || '',
      poNumber: document.getElementById('po').value || '',
      trailerNumber: document.getElementById('trailer').value || '',
      stopNumber: document.getElementById('stop').value || '',
      carrier: document.getElementById('carrier').value || '',
      vendorId: document.getElementById('vendorId').value || '',
      vendorName: document.getElementById('vendorName').value || '',
      notes: document.getElementById('notes').value || '',
      driverName,
      proNumber: document.getElementById('proNumber').value || '',
      signatureDataUrl: window.signatureDataUrl || '',
      photos,
      device: navigator.userAgent,
      submittedAt: new Date().toISOString(),
      // email controls
      toEmail:  document.getElementById('toEmail').value || '',
      ccEmail:  document.getElementById('ccEmail').value || '',
      bccEmail: document.getElementById('bccEmail').value || '',
      subject:  document.getElementById('emailSubject').value || '',
      message:  document.getElementById('emailMessage').value || ''
    };

    submitBtn.disabled = true;
    try{
      const resp = await fetch(BACKEND_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const out = await resp.json().catch(()=> ({}));
      if(!resp.ok || out.ok === false) throw new Error(out.error || 'Submit failed');
      alertBox.innerHTML = `<div class="alert success">✅ Submitted! PDF emailed${out.id ? ' · Ref: ' + out.id : ''}.</div>`;
      form.reset(); ctx.clearRect(0,0,canvas.width,canvas.height); window.signatureDataUrl=''; thumbs.innerHTML='';
    }catch(err){
      console.error(err); alertBox.innerHTML = `<div class="alert error">❌ ${err.message}</div>`;
    }finally{ submitBtn.disabled = false; }
  });
</script>
</body>
</html>

